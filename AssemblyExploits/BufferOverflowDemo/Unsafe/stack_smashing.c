#include <stdio.h>
#include <string.h>

int main(int argc, char *argv[])
{
	//Check there is an input argument
	if(argc<2)
	{
		printf("Include a password to evaluate (e.g: ./stack_smashing hello world)\n");
		exit(0);
	}
	
	//Declare buffers (note use of unsafe "strcpy")
	int secretValue = 0;
	char bufferOne[10], bufferTwo[10];

/*	
	STACK ORDER (GROWS TOWARDS THE LOW MEMORY ADDRESSES)
	
	--TOP (HIGH ADDRESS)--
		secretValue
		bufferOne
		bufferTwo
	--BOTTOM (LOW ADDRESS)--
	
	Its possible for an input string of more than 20 bytes to overflow both buffers and
	alter the secretValue, leading to the execution of the secret function
*/

	//Placeholders
	strcpy(bufferOne, "One");
	strcpy(bufferTwo, "Two");

	//Show initial buffer values
	printf("[BEFORE] buffer_two is at %p and contains \'%s\'\n", bufferTwo, bufferTwo); //%p = position in memory
	printf("[BEFORE] buffer_one is at %p and contains \'%s\'\n", bufferOne, bufferOne); //%s = string representation of variable
	printf("[BEFORE] secretValue is at %p and is %d (0x%08x)\n", &secretValue, secretValue, secretValue); //%x = hex location

	//Copy user input into buffer two. If input > size of bufferTwo, bufferTwo overflows into bufferOne
	printf("\n[STRCPY] copying %d bytes into buffer_two\n\n",  strlen(argv[1]));
	strcpy(bufferTwo, argv[1]);

	//Show buffer values after strcpy
	printf("[AFTER] buffer_two is at %p and contains \'%s\'\n", bufferTwo, bufferTwo);
	printf("[AFTER] buffer_one is at %p and contains \'%s\'\n", bufferOne, bufferOne);
	printf("[AFTER] secretValue is at %p and is %d (0x%08x)\n", &secretValue, secretValue, secretValue); 
	
	//Evaluate secret value
	if(secretValue == 0)
	{
		//No change in secretValue
		exit(0);
	}
	else
	{
		//Even though secretValue is not altered in the code or user input, its possible to execute this function
		printf("YOU HAVE UNLOCKED THE SECRET FUNCTION!\n");
		exit(0);	
	}
}
